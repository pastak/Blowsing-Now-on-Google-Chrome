<html>
<script>
function getinfo(){
chrome.windows.getCurrent(function(_window){
chrome.tabs.getSelected(_window.id, function(tab){
		var url=tab.url;
		var search=url.split("?")[1];
		var ret=search.split("&");
		var get = new Object();

		for(var i = 0; i < ret.length; i++) {
			var r = ret[i].split("=");
			get[r[0]] = r[1];
		}
		document.getElementById("token").value=get["t"];
		document.getElementById("token_s").value=get["s"];
});
});
}
function setting(){
	var t=("'"+document.getElementById("token").value+"'");
	var s=("'"+document.getElementById("token_s").value+"'");
	var Config = {
		token:t,
		secret:s
	};
	localStorage.BlowsingNowConfigData = JSON.stringify(Config);
	setcheck();
}
function setcheck(){
	if(localStorage.BlowsingNowConfigData){
   		document.getElementById("oauth").style.display="none";
   		document.getElementById("set").style.display="block";
	}else{
   		document.getElementById("oauth").style.display="none";
   		document.getElementById("setmiss").style.display="block";
	}
}
function open_oauth(){
chrome.windows.getCurrent(function(_window){
chrome.tabs.getSelected(_window.id, function(tab){
	chrome.tabs.create({
		index:tab.index+1,
		url:'http://pastak.cosmio.net/browsing_now_chrome/',
		selected:true
	});
});
});
}
function blowsingnow(){
	document.getElementById("prompt").style.display="none";
	document.getElementById("sending").style.display="block";
	chrome.windows.getCurrent(function(_window){
		chrome.tabs.getSelected(_window.id, function(tab){
			var Config = JSON.parse(localStorage.BlowsingNowConfigData);
		  	var url=tab.url;
		  	var title=tab.title;
		  	var token=Config['token'].replace(/\'/g,"");
		  	var secret=Config['secret'].replace(/\'/g,"");
		  	var text=document.getElementById('userinput').value;
		  	var req=("http://pastak.cosmio.net/browsing_now_chrome/submit.php"+"?url="+encodeURIComponent(url)+"&title="+encodeURIComponent(title)+"&token="+token+"&secret="+secret+"&text="+encodeURIComponent(text));
		    console.log(req);
		    var xhr=new XMLHttpRequest();
		    xhr.open("get",req,false);
		    xhr.onreadystatechange=function(){
		    	if(xhr.readyState==4){
		    		if(xhr.status == 200){
			    		document.getElementById("sending").style.display="none";
			    		document.getElementById("success").style.display="block";
			    	}else{
			    		document.getElementById("sending").style.display="none";
			    		document.getElementById("error").style.display="block";
			    	}
		    	};
		    };
		    xhr.send(null);
		});
	});
}

function load(){
	
	if(localStorage.BlowsingNowConfigData){
		document.body.style.width="450px";
		document.getElementById("prompt").style.display="block";
		document.getElementById("userinput").focus();
		preview();
	}else{
		document.body.style.width="400px";
		document.getElementById("oauth").style.display="block";
	};
}
function preview(){
chrome.windows.getCurrent(function(_window){
	chrome.tabs.getSelected(_window.id, function(tab){
		var u=document.getElementById("userinput").value;
		if(u===''){
		u='Now browsing';
		}
		document.getElementById("preview").textContent=(u+'：'+tab.title+"&nbsp;"+tab.url);
	})
})
}
</script>
<body style="width:200px;">

<div id="error" style="display:none;">
送信エラーです。
もう１回やり直して下さい m(_ _)m
</div>

<div id="prompt" style="display:none;">
	プレビュー<br>
	<div style="border:2px solid black">
	<div id="preview" style="color:black;margin:4px;"></div>
	</div>
	<br>
	<span style="font-size:10px;margin:3px;color:red;">※URLが短縮されるなどする場合があります</span><br>
	<form onsubmit="blowsingnow();return false;">
	<input type="text" onkeydown="preview();" onkeypress="preview();" size="60" id="userinput"><br>
	<input type="submit" onclick="blowsingnow();" value="送信">
	</form>
</div>

<div id="sending" style="display:none;">
<img src="loading.gif">
<span>
Now Sending...
</span>
</div>

<div id="success" style="display:none;">
	Tweeting successed.
</div>

<div id="oauth" style="display:none;">
下のバナーをクリックして認証ページへ<br />
<img src="oauth.png" onClick="open_oauth();"><br />
<br>
<h3>フォーム情報の確認</h3>
<input type="button" value="取得" onClick="getinfo();">
<br>
<strong>oauth_token</strong><br /><input type="text"  size="60" id="token"><br />
<strong>oauth_token_secret</strong><br /><input type="text" size="60" id="token_s"><br />
<input type="button" onclick="setting();" value="登録">
</div>

<div id="set" style="display:none;">
登録に成功しました
</div>

<div id="setmiss" style="display:none;">
登録に失敗しました。<br>
もう一度やり直して下さい。
</div>

<script>
load();
</script>
</body>
</html>
